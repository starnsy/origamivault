<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encrypt content | OrigamyVault - Encrypt & Store on Paper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Azeret+Mono:wght@400;700&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #d5b882 0%, #f1ebda 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 650px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(116, 85, 48, 0.2);
        }

        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo {
            max-width: 120px;
            height: auto;
            margin: 0 auto 10px;
        }

        .subtitle {
            color: #745530;
            font-size: 14px;
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: #745530;
            margin-bottom: 30px;
            text-align: center;
            font-size: 27px;
        }

        h1 span {
            background: linear-gradient(135deg, #745530 0%, #d5b882 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #745530;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'SF Mono', 'Consolas', 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #745530 0%, #d5b882 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        #qrcode {
            margin-top: 30px;
            text-align: center;
            display: none;
        }

        #qrcode canvas, #qrcode img {
            margin: 0 auto;
            border-radius: 8px;
        }

        .qr-title {
            margin-bottom: 15px;
            color: #745530;
            font-weight: 600;
            font-size: 18px;
        }

        .print-instruction {
            margin-top: 20px;
            text-align: center;
            color: #555;
            font-size: 16px;
        }

        .decrypt-link {
            margin-top: 15px;
            text-align: center;
        }

        .decrypt-link a {
            color: #745530;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
        }

        .decrypt-link a:hover {
            text-decoration: underline;
        }

        .qr-container {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .qr-item {
            flex: 1;
            min-width: 280px;
            max-width: 100%;
            text-align: center;
        }

        .qr-item.with-side-layout {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 15px;
            text-align: left;
        }

        .qr-item.with-side-layout #qrLinkContainer {
            flex-shrink: 0;
        }

        .qr-item.with-side-layout .qr-content {
            flex: 1;
        }

        .qr-label {
            font-weight: 600;
            color: #745530;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .qr-description {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
            line-height: 1.4;
        }

        .explanation, .info-text {
            margin-top: 25px;
            padding: 15px;
            background: #f1ebda;
            border-radius: 8px;
            color: #745530;
            font-size: 14px;
            line-height: 1.6;
            text-align: left
        }

        .explanation strong {
            color: #745530;
        }

        .print-button {
            margin-top: 25px;
            width: 100%;
            background: #28a745;
        }

        .print-button:hover {
            background: #218838;
        }

        .encrypted-text-box {
            margin-top: 20px;
            padding: 15px;
            background: #f1ebda;
            border-radius: 8px;
            border: 1px solid #d5b882;
        }

        .encrypted-text-box h3 {
            color: #745530;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .encrypted-text-box textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #d5b882;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            background: white;
            color: #745530;
            resize: vertical;
        }

        .decrypt-js-code {
            margin-top: 20px;
            padding: 15px;
            background: #f1ebda;
            border-radius: 8px;
            border: 1px solid #d5b882;
        }

        .decrypt-js-code h3 {
            color: #745530;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .decrypt-js-code .code {
            padding: 10px;
            background: #2d2d2d;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            color: #a9dc76;
            overflow-x: auto;
            cursor: pointer;
            word-break: break-all;
            user-select: all;
        }

        .decrypt-js-code .code:hover {
            background: #3d3d3d;
        }

        .link {
            text-align: center;
            margin-top: 20px;
        }

        .link a {
            color: #745530;
            text-decoration: none;
            font-weight: 500;
        }

        .link a:hover {
            text-decoration: underline;
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #745530;
        }

        .footer a {
            color: #745530;
            text-decoration: none;
            font-weight: 600;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .show-print {
            display: none;
        }

        @media print {
            @page {
                size: portrait;
            }

            * {
                color: black !important;
            }

            .dont-print {
                display: none;
            }

            .show-print {
                display: block;
            }

            .print-button {
                display: none;
            }
            .decrypt-link-box {
                display: none;
            }
            .qr-title {
                display: none;
            }
            .logo-container {
                display: none;
            }
            .subtitle {
                display: none;
            }
            .footer {
                display: none;
            }
            body {
                background: white;
            }
            .container {
                box-shadow: none;
            }
            .qr-container {
                flex-direction: column;
                align-items: center;
            }

            .qr-item:first-child {
                display: flex;
                flex-direction: row;
                align-items: flex-start;
                gap: 15px;
                text-align: left;
            }

            .qr-item:first-child #qrLinkContainer {
                flex-shrink: 0;
                order: -1;
            }

            .decrypt-js-code {
                border: 1px solid black;
                padding: 5px;
                background: white;
                color: #000000;
            }

            .decrypt-js-code h3 {
                color: black;
            }

            .decrypt-js-code .code {
                background: white;
                color: black;
                border: none;
                font-family: "Azeret Mono", monospace;
                font-size: 12px;
                letter-spacing: 0.05em;  /* a bit more spacing helps OCR */
                line-height: 1.2;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="logo.png" alt="OrigamiVault Logo" class="logo">
        </div>
        <h1><span>OrigamiVault</span> - Encrypt & Store on Paper</h1>

        <div class="explanation" id="securityTip" style="margin-bottom: 20px;">
            <strong>Security tip:</strong> For better security, turn off internet and use incognito browser mode.
        </div>

        <div id="formSection">
            <div class="form-group">
                <label for="content">Content to Encrypt</label>
                <textarea id="content" placeholder="Enter your secret message..."></textarea>
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter a strong password" autocomplete="off" data-lpignore="true" data-form-type="other">
            </div>

            <button onclick="encryptAndGenerateQR()">Encrypt & Generate QR Code</button>

            <div class="link">
                <a href="decrypt.html">Go to Decrypt Page</a>
            </div>
        </div>

        <div id="qrcode"></div>
    </div>

    <div class="footer">
        <a href="https://github.com/declegacy/origamivault" target="_blank">OrigamiVault</a> is open source project
    </div>

    <script>
        async function encryptAndGenerateQR() {
            const content = document.getElementById('content').value;
            const password = document.getElementById('password').value;

            if (!content) {
                alert('Please enter content to encrypt');
                return;
            }

            if (!password) {
                alert('Please enter a password');
                return;
            }

            // Encrypt the content using Web Crypto API (AES-CBC, 128-bit)
            const encoder = new TextEncoder();
            const passwordBytes = encoder.encode(password);
            const contentBytes = encoder.encode(content);

            // Static salt and IV (for shorter QR codes)
            const salt = new Uint8Array(16); // All zeros
            const iv = new Uint8Array(16); // All zeros

            // Derive key from password using PBKDF2
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                passwordBytes,
                'PBKDF2',
                false,
                ['deriveKey']
            );

            const key = await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-CBC', length: 128 },
                false,
                ['encrypt']
            );

            // Encrypt
            const ciphertext = await crypto.subtle.encrypt(
                { name: 'AES-CBC', iv: iv },
                key,
                contentBytes
            );

            // Base64 ciphertext for emergency code (without prefix)
            const encryptedBase64 = btoa(String.fromCharCode(...new Uint8Array(ciphertext)));

            // Format: [OV_v1] + base64(ciphertext) for QR code
            const encrypted = '[OV_v1]' + encryptedBase64;

            // Change the title
            document.querySelector('h1').textContent = 'Encrypted content';

            // Hide the form section and security tip
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('securityTip').style.display = 'none';

            // Get current base URL dynamically
            const baseUrl = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '');
            const decryptUrl = baseUrl + '/decrypt.html';

            // Clear previous QR code if any
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = `
                <div class="qr-title">Print these QR codes</div>

                <div class="explanation dont-print">
                    These two QR codes are needed to decrypt the content later. Scan the first QR code to open the decrypt web app, and then scan the second QR code on that page to retrieve the encrypted data.
                </div>

                <div class="qr-container">
                    <div class="qr-item">
                        <div class="qr-label dont-print">1. App Link QR Code</div>
                        <div id="qrLinkContainer"></div>
                        <div class="qr-description">
                            <div class="qr-label show-print">1. Decrypt App Link</div>
                            Scan code with your phone camera to open decriptor on this url: ${decryptUrl}. <br/>
                            
                            <div style="margin-top: 10px; font-size: 90%">
                                Alternatively, the full source code is also available on: <br/>
                                https://github.com/declegacy/origamivault <br/>
                                https://gitlab.com/declegacy/origamivault
                            </div>
                        </div>
                    </div>

                    <div class="qr-item">
                        <div class="qr-label">2. Encrypted Data QR Code</div>
                        <div id="qrDataContainer"></div>
                        <div class="qr-description">Scan this code on the decrypt web app</div>

                        <div class="decrypt-js-code">
                            <h3>Emergency/alternative decryption code</h3>
                            <div class="code" onclick="navigator.clipboard.writeText(this.textContent).then(()=>{this.style.background='#4d4d4d'; setTimeout(()=>this.style.background='#2d2d2d', 200)})" title="Click to copy"><code>(async()=>{try{const p=prompt("Enter password:");if(!p)return;const c="${encryptedBase64.replace(/"/g, '\\"')}";const salt=new Uint8Array(16);const iv=new Uint8Array(16);const ciphertext=new Uint8Array(atob(c).split("").map(x=>x.charCodeAt(0)));const keyMaterial=await crypto.subtle.importKey("raw",new TextEncoder().encode(p),"PBKDF2",false,["deriveKey"]);const key=await crypto.subtle.deriveKey({name:"PBKDF2",salt:salt,iterations:100000,hash:"SHA-256"},keyMaterial,{name:"AES-CBC",length:128},false,["decrypt"]);const decrypted=await crypto.subtle.decrypt({name:"AES-CBC",iv:iv},key,ciphertext);alert(new TextDecoder().decode(decrypted))}catch(e){alert("Wrong Password")}})()</code></div>
                            <div style="margin-top:7px; font-size: 70%; color: #745530">Works offline, executable in browser console (open it via CMD+OPTION+I or CTRL + SHIFT + I)</div>
                        </div>
                    </div>
                </div>

                <button class="print-button" onclick="window.print()">Print QR Codes</button>

                <div class="decrypt-link-box" style="text-align: center; margin-top: 15px;">
                    <a href="${decryptUrl}" target="_blank" style="color: #745530; text-decoration: none; font-weight: 500; font-size: 14px;">Open decrypt page in new tab â†’</a>
                </div>

                <div class="info-text dont-print">
                    For additional security and redundancy, you can save the decryption app (press Ctrl+S or Cmd+S on <a href="decrypt.html" target="_blank">decrypt.html</a>). HTML and JavaScript work well without server-side hosting. With the saved app, you will be able to decrypt content even if GitHub is offline.
                    Alternatively, you can fork/clone/download the entire app on <a target="_blank" href="https://github.com/declegacy/origamivault">GitHub</a>.
                </div>
            `;
            qrcodeDiv.style.display = 'block';

            // Generate QR code for decrypt link
            new QRCode(document.getElementById('qrLinkContainer'), {
                text: decryptUrl,
                width: 150,
                height: 150,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });

            // Generate QR code for encrypted data
            new QRCode(document.getElementById('qrDataContainer'), {
                text: encrypted,
                width: 260,
                height: 260,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
    </script>
</body>
</html>
